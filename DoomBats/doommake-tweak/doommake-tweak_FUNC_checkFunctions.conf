/* ========================================================================== */
/* TWEAK ---- NEW AND MODIFIED FUNCTIONS FOR DOOMMAKE.SCRIPT                  */
/* ========================================================================== */

/* ------------------------------------------------------------------------ */
/* This is the deco function */
/* Creates a WAD containing ONLY the DEHACKED lump */
check function doDehWad() {

    initBuild();

    outWad = getBuildDirectory() + "/dehacked.wad";
    sourceDir = getSourceDirectory() + SRC_DECOHACK;
    verifydirs(sourceDir);

    if (checkFileExistenceAndBuildStatuses(outWad, ["dehacked"])) {
        hash = directoryHasChanged(sourceDir);
        if (hash === null) {
            println("[Skipped] DEH-only WAD up to date.");
            return;
        }
    } else {
        hash = getDirectoryHash(sourceDir);
    }

    println("Building DEH-only WAD: " + outWad);

    // Run WadMerge with our custom script.
    // %1 = build dir, %2 = src dir (see merge-dehonly.txt below).
    wadmerge(file("scripts/merge-dehonly.txt"), [
        getBuildDirectory(),
        getSourceDirectory()
    ]);

    storeDirectoryChanged(sourceDir, hash);
    setBuilt("dehonly");
}

/* ------------------------------------------------------------------------ */
/* Builds the texture WAD using Restricted texture list */
/* Creates textures-Restricted WAD */
check function doTexturesRestricted() {

	initBuild();

	println("Running TextureRestricted");

	// Step 1: Check if texture1.txt differs from texture1-Restricted.txt
	// If different, copy texture1.txt to texture1-Restricted.txt
	sourceTexture = getSourceDirectory() + "/textures/texture1.txt";
	restrictedTexture = "scripts/textureX/texture1-Restricted.txt";
	
	if (fileexists(sourceTexture)) {
		// If restricted doesn't exist OR files are different, copy
		if (!fileexists(restrictedTexture)) {
			println("Creating texture1-Restricted.txt from texture1.txt...");
			copyfile(file(sourceTexture), file(restrictedTexture), true);
		} else {
			// Check if they're different by comparing file sizes first (quick check)
			// Note: RookScript may not have direct content comparison, so we always copy to be safe
			// This ensures texture1-Restricted.txt is always in sync
			copyfile(file(sourceTexture), file(restrictedTexture), true);
		}
	}

	// Step 2: Build textures-Restricted.wad (always build, no skip check)
	outWad = getBuildDirectory() + "/textures-Restricted.wad";

	sourceDir = getSourceDirectory() + SRC_DIR_TEXTURES;
	verifydirs(sourceDir + "/flats");
	verifydirs(sourceDir + "/patches");
	verifydirs(sourceDir + "/texture1");
	verifydirs(sourceDir + "/texture2");

	println("Building textures (Restricted)...");

	wadmerge(file("scripts/merge-textures-Restricted.txt"), [
		getBuildDirectory(),
		getSourceDirectory(),
		"textures-Restricted.wad"
	]);
	
	// Copy to textures.wad (always happens, even on skip)
	destWad = getBuildDirectory() + "/textures.wad";
	println("Copying textures-Restricted.wad to textures.wad...");
	copyfile(file(outWad), file(destWad), true);
	
	setBuilt("textures-restricted");
}

/* ------------------------------------------------------------------------ */
/* Builds the texture WAD using All texture list */
/* Creates textures-All WAD */
check function doTexturesAll(updateRestricted) {

	initBuild();

	println("Running TextureAll");

	// Step 1 & 2: Sync texture1-Restricted.txt if needed
	if (updateRestricted) {
		sourceTexture = getSourceDirectory() + "/textures/texture1.txt";
		restrictedTexture = "scripts/textureX/texture1-Restricted.txt";
		
		if (fileexists(sourceTexture)) {
			copyfile(file(sourceTexture), file(restrictedTexture), true);
		}
	}

	// Step 3: Copy doom2Default to All as base
	doom2DefaultTexture = "scripts/textureX/texture1-doom2Default.txt";
	allTexture = "scripts/textureX/texture1-All.txt";
	restrictedTexture = "scripts/textureX/texture1-Restricted.txt";
	
	if (fileexists(doom2DefaultTexture)) {
		println("Creating texture1-All.txt from doom2Default...");
		copyfile(file(doom2DefaultTexture), file(allTexture), true);
	}

	// Step 4 & 5: Append header and custom textures
	// Use Windows cmd to append files
	if (fileexists(restrictedTexture) && fileexists(allTexture)) {
		println("Appending custom textures to texture1-All.txt...");
		
		// First append the header
		exec("cmd", ["/c", "echo. >> scripts\\textureX\\texture1-All.txt"]);
		exec("cmd", ["/c", "echo. >> scripts\\textureX\\texture1-All.txt"]);
		exec("cmd", ["/c", "echo ; --------------------------------------- >> scripts\\textureX\\texture1-All.txt"]);
		exec("cmd", ["/c", "echo ; ---- DoomTools Texture Imports -------- >> scripts\\textureX\\texture1-All.txt"]);
		exec("cmd", ["/c", "echo ; --------------------------------------- >> scripts\\textureX\\texture1-All.txt"]);
		exec("cmd", ["/c", "echo. >> scripts\\textureX\\texture1-All.txt"]);
		
		// Append from line 20 onwards of Restricted (skip first 19 lines)
		exec("cmd", ["/c", "more /E +19 scripts\\textureX\\texture1-Restricted.txt >> scripts\\textureX\\texture1-All.txt"]);
	}

	// Step 6: Build textures-All.wad (always build, no skip check)
	outWad = getBuildDirectory() + "/textures-All.wad";

	sourceDir = getSourceDirectory() + SRC_DIR_TEXTURES;
	verifydirs(sourceDir + "/flats");
	verifydirs(sourceDir + "/patches");
	verifydirs(sourceDir + "/texture1");
	verifydirs(sourceDir + "/texture2");

	println("Building textures (All)...");

	wadmerge(file("scripts/merge-textures-All.txt"), [
		getBuildDirectory(),
		getSourceDirectory(),
		"textures-All.wad"
	]);
	
	// Copy to textures.wad (always happens, even on skip)
	destWad = getBuildDirectory() + "/textures.wad";
	println("Copying textures-All.wad to textures.wad...");
	copyfile(file(outWad), file(destWad), true);
	
	setBuilt("textures-all");
}

/* ------------------------------------------------------------------------ */
/* Builds a full release but with no patch */
/* Creates a release WAD */
check function doReleaseNoPatch() {
    outFile = getBuildDirectory() + "/" + getProjectWAD();
    // NOTE: do not include "dehacked" as a dependency here.
    if (checkFileExistenceAndBuildStatuses(outFile, ["maps", "assets", "maptextures"])) {
        println("[Skipped] No pertinent project data built.");
        return;
    }
    wadmerge(file(MERGESCRIPT_RELEASE_NOPATCH), [
        getBuildDirectory()
        ,getSourceDirectory()
        ,getProjectWad()
        ,getAssetsWAD()
        ,getMapsWad()
        ,getMapTexWad()
    ]);
    setBuilt("release");
}

/* -------------------------------------------------------------------------- */
/* Builds a wad containing only the playpal primary colourmaps and colourmaps */
/* creates - palette.wad */
#define PROP_PALETTEWAD      "doommake.file.palette"
#define DEFAULT_PALETTEWAD   "palette.wad"
#define MERGESCRIPT_PALETTE  "scripts/merge-palette.txt"
function getPaletteWad() {
	return prop(PROP_PALETTEWAD, DEFAULT_PALETTEWAD); 
}

check function doPalette() {
	
	initBuild();

	outWad = getBuildDirectory() + "/" + getPaletteWad();

	// Check convert directories
	convertPalettesDir = getSourceDirectory() + SRC_DIR_CONVERT + "/palettes";
	convertColormapsDir = getSourceDirectory() + SRC_DIR_CONVERT + "/colormaps";
	convertColormapsSecDir = getSourceDirectory() + SRC_DIR_CONVERT + "/colormaps-secondary";
	
	// Check asset directories
	assetPalettesDir = getSourceDirectory() + SRC_DIR_ASSETS + "/palettes";
	assetColormapsDir = getSourceDirectory() + SRC_DIR_ASSETS + "/colormaps";
	assetColormapsSecDir = getSourceDirectory() + SRC_DIR_ASSETS + "/colormaps-secondary";
	
	// Verify directories exist
	verifydirs(convertPalettesDir);
	verifydirs(convertColormapsDir);
	verifydirs(convertColormapsSecDir);
	verifydirs(assetPalettesDir);
	verifydirs(assetColormapsDir);
	verifydirs(assetColormapsSecDir);
		
	if (checkFileExistenceAndBuildStatuses(outWad, ["convert-palettes", "convert-colormaps", "convert-colormaps-secondary"])) {
		// Check both convert and asset directories for changes
		hashConvertPalettes = directoryHasChanged(convertPalettesDir);
		hashConvertColormaps = directoryHasChanged(convertColormapsDir);
		hashConvertColormapsSec = directoryHasChanged(convertColormapsSecDir);
		hashAssetPalettes = directoryHasChanged(assetPalettesDir);
		hashAssetColormaps = directoryHasChanged(assetColormapsDir);
		hashAssetColormapsSec = directoryHasChanged(assetColormapsSecDir);
		
		if (hashConvertPalettes === null && hashConvertColormaps === null && 
		    hashConvertColormapsSec === null && hashAssetPalettes === null && 
		    hashAssetColormaps === null && hashAssetColormapsSec === null) {
			println("[Skipped] Palette and colormap directories are up to date.");
			return;
		}
	}
	
	println("Building palette WAD...");
	
	wadmerge(file(MERGESCRIPT_PALETTE), [
		getBuildDirectory(),
		getSourceDirectory(),
		getPaletteWad()
	]);
	
	// Store directory hashes
	storeDirectoryChanged(convertPalettesDir, getDirectoryHash(convertPalettesDir));
	storeDirectoryChanged(convertColormapsDir, getDirectoryHash(convertColormapsDir));
	storeDirectoryChanged(convertColormapsSecDir, getDirectoryHash(convertColormapsSecDir));
	storeDirectoryChanged(assetPalettesDir, getDirectoryHash(assetPalettesDir));
	storeDirectoryChanged(assetColormapsDir, getDirectoryHash(assetColormapsDir));
	storeDirectoryChanged(assetColormapsSecDir, getDirectoryHash(assetColormapsSecDir));
	
	setBuilt("palette");
}

/* -------------------------------------------------------------------------- */
/* Builds a complete playable WAD with all assets, textures, and maps */
/* Creates release-ProjectName.wad directly without intermediate WAD files */
#define MERGESCRIPT_PLAYPALALL  "scripts/merge-playpal-all.txt"

function getPlayPalAllWad() {
	projectName = prop("doommake.project.name", "project");
	return "release-" + projectName + ".wad";
}

check function doPlayPalAll() {
	
	initBuild();
	outFile = getBuildDirectory() + "/" + getPlayPalAllWad();
	
	println("Building playpal-all WAD...");
	
	wadmerge(file(MERGESCRIPT_PLAYPALALL), [
		getBuildDirectory(),
		getSourceDirectory(),
		getPlayPalAllWad()
	]);
	
	setBuilt("playpalall");
}
/* === END OF TWEAK ========================================================= */
/* ========================================================================== */
